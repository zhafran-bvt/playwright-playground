name: Playwright Tests & Deploy Allure Report to Netlify

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    env:
      TEST_USER: ${{ secrets.TEST_USER }}
      TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      API_CLIENT_ID: ${{ secrets.API_CLIENT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run Playwright tests
        run: npm run test

      - name: Generate Allure report
        if: always()
        run: npm run allure:generate

      - name: Add Netlify headers for Allure attachments
        if: always()
        run: |
          echo '/attachments/*\n  Content-Type: image/png' > allure-report/_headers

      - name: Deploy Allure report to Netlify
        if: always()
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm install -g netlify-cli
          npx netlify deploy --dir=allure-report --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN --prod

      - name: Share Netlify URL
        if: always()
        run: echo "Allure report deployed to Netlify. Visit your Netlify dashboard to get the public URL."
